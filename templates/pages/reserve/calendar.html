{% extends "base.html" %}
{% block title %}{{ SITE_NAME }} | ë‹¬ë ¥ì˜ˆì•½{% endblock %}

{% block content %}

<section class="sec reserve-cal">
    <div class="container">

        <div class="cal-head">
            <div class="cal-month-wrap">
                <button class="cal-nav" type="button" id="calPrev" aria-label="ì´ì „ ë‹¬">â€¹</button>
                <div class="cal-month" id="calMonthText">2026ë…„ 02ì›”</div>
                <button class="cal-nav" type="button" id="calNext" aria-label="ë‹¤ìŒ ë‹¬">â€º</button>
            </div>

            <div class="cal-sub">ì›í•˜ì‹œëŠ” ì˜ˆì•½ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
        </div>

        <div class="cal-cta">
            <!-- âœ… ë‹¬ë ¥ì˜ˆì•½ í˜ì´ì§€ ìƒë‹¨ì— ì¡´ì¬í•´ì•¼ í•¨ -->
            <button class="btn btn-dark cal-confirm" type="button" id="calConfirmBtn">
                <span class="cal-confirm-ico" aria-hidden="true">ğŸ“…</span> <span class="cal-confirm-txt">ì˜ˆì•½í™•ì¸</span>
            </button>
        </div>

        <div class="cal-divider"></div>

        <div class="cal-wrap">
            <div class="cal-week cal-week--head">
                <div class="cal-dow sun">ì¼ìš”ì¼</div>
                <div class="cal-dow">ì›”ìš”ì¼</div>
                <div class="cal-dow">í™”ìš”ì¼</div>
                <div class="cal-dow">ìˆ˜ìš”ì¼</div>
                <div class="cal-dow">ëª©ìš”ì¼</div>
                <div class="cal-dow">ê¸ˆìš”ì¼</div>
                <div class="cal-dow sat">í† ìš”ì¼</div>
            </div>

            <div class="cal-grid" id="calGrid"></div>
        </div>

    </div>
</section>

<!-- =========================
     Confirm Modal (Reference style)
     - ë‚ ì§œ í´ë¦­í•˜ë©´ ë°”ë¡œ ëœ¸
     ========================= -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rsv-modal">

            <div class="modal-header rsv-head">
                <div class="rsv-title">ì˜ˆì•½ì ì •ë³´</div>
                <button type="button" class="rsv-x" data-bs-dismiss="modal" aria-label="ë‹«ê¸°">Ã—</button>
            </div>

            <div class="modal-body rsv-body">
                <form class="rsv-form" id="reserveForm" onsubmit="return false;">

                    <div class="rsv-grid">
                        <!-- ì˜ˆì•½ ì„ íƒì¼ -->
                        <div class="rsv-row">
                            <div class="rsv-label">ì˜ˆì•½ ì„ íƒì¼</div>
                            <div class="rsv-field">
                                <input class="rsv-input" id="cfDateInput" readonly>
                            </div>
                        </div>

                        <!-- ì˜ˆì•½ ì„ íƒ ì‹œê°„ -->
                        <div class="rsv-row">
                            <div class="rsv-label">ì˜ˆì•½ ì„ íƒ ì‹œê°„</div>
                            <div class="rsv-field">
                                <select class="rsv-input" id="cfTimeSelect">
                                    <option value="">ì˜ˆì•½ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</option>
                                </select>
                                <!-- âœ… ì»¤ìŠ¤í…€ í™”ì‚´í‘œ -->
                                <svg class="rsv-select-arrow" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                        </div>

                        <!-- ì´ë¦„ -->
                        <div class="rsv-row">
                            <div class="rsv-label">ì´ë¦„</div>
                            <div class="rsv-field">
                                <input class="rsv-input" id="cfName" placeholder="ì´ë¦„">
                            </div>
                        </div>

                        <!-- ì—°ë½ì²˜ -->
                        <div class="rsv-row">
                            <div class="rsv-label">ì—°ë½ì²˜</div>
                            <div class="rsv-field">
                                <input class="rsv-input" id="cfPhone" placeholder="- ë¥¼ ì œì™¸í•œ ìˆ«ìë§Œ ì…ë ¥">
                            </div>
                        </div>

                        <!-- ìƒë…„ì›”ì¼ -->
                        <div class="rsv-row">
                            <div class="rsv-label">ìƒë…„ì›”ì¼</div>
                            <div class="rsv-field">
                                <input class="rsv-input" id="cfBirth" placeholder="ìƒë…„ì›”ì¼(YYYY-MM-DD)">
                            </div>
                        </div>

                        <!-- ì„±ë³„ -->
                        <div class="rsv-row">
                            <div class="rsv-label">ì„±ë³„</div>
                            <div class="rsv-field">
                                <div class="rsv-radio">
                                    <label class="rsv-radio-item">
                                        <input type="radio" name="cfGender" value="ë‚¨">
                                        <span>ë‚¨</span>
                                    </label>
                                    <label class="rsv-radio-item">
                                        <input type="radio" name="cfGender" value="ì—¬">
                                        <span>ì—¬</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- ì§„ë£Œì¢…ë¥˜ -->
                        <div class="rsv-row">
                            <div class="rsv-label">ì§„ë£Œì¢…ë¥˜</div>
                            <div class="rsv-field">
                                <div class="rsv-radio">
                                    <label class="rsv-radio-item">
                                        <input type="radio" name="cfVisitType" value="ì´ˆì§„">
                                        <span>ì´ˆì§„</span>
                                    </label>
                                    <label class="rsv-radio-item">
                                        <input type="radio" name="cfVisitType" value="ì¬ì§„">
                                        <span>ì¬ì§„</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- í¬ë§ì§„ë£Œì‚¬í•­ -->
                        <div class="rsv-row rsv-row--textarea">
                            <div class="rsv-label">í¬ë§ì§„ë£Œì‚¬í•­</div>
                            <div class="rsv-field">
                                <textarea class="rsv-input rsv-textarea" id="cfMemo"
                                    placeholder="ì¦ìƒ/ìš”ì²­ì‚¬í•­ì„ ê°„ë‹¨íˆ ì ì–´ì£¼ì„¸ìš”."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="rsv-note">
                        2024ë…„ 5ì›” 20ì¼ë¶€í„° ê±´ê°•ë³´í—˜ ë³¸ì¸í™•ì¸ ì˜ë¬´í™” ì œë„ê°€ ì‹œí–‰ë˜ë©° ë³‘ì› ë°©ë¬¸ ì‹œ ì‹ ë¶„ì¦ì„ í•„ìˆ˜ë¡œ ì œì‹œí•´ì£¼ì–´ì•¼í•©ë‹ˆë‹¤.
                    </div>

                    <div class="rsv-consent">
                        <label class="rsv-check rsv-check--all">
                            <input type="checkbox" id="agreeAll">
                            <span>ëª¨ë‘ ë™ì˜í•©ë‹ˆë‹¤</span>
                        </label>

                        <div class="rsv-consent-list">
                            <label class="rsv-check">
                                <input type="checkbox" class="agree-item" id="agreeUse">
                                <span>ì´ìš©ì•½ê´€ ë™ì˜ <a href="javascript:void(0)" class="rsv-link">ì•½ê´€ë³´ê¸°</a></span>
                            </label>

                            <label class="rsv-check">
                                <input type="checkbox" class="agree-item" id="agreePrivacy">
                                <span>ê°œì¸ì •ë³´ ì·¨ê¸‰ë°©ì¹¨ ë™ì˜ <a href="javascript:void(0)" class="rsv-link">ì•½ê´€ë³´ê¸°</a></span>
                            </label>
                        </div>
                    </div>

                    <div class="rsv-actions">
                        <button class="rsv-submit" type="button" id="cfSubmitBtn">ì˜ˆì•½ì‹ ì²­</button>
                    </div>

                </form>
            </div>

        </div>
    </div>
</div>

<!-- =========================
     Reserve Check Modal (ì¡°íšŒí•˜ê¸°)
     - ìƒë‹¨ "ì˜ˆì•½í™•ì¸" ë²„íŠ¼ ì „ìš©
     ========================= -->
<div class="modal fade" id="checkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rsv-modal">

            <div class="modal-header rsv-head">
                <div class="rsv-title">ì˜ˆì•½í™•ì¸</div>
                <button type="button" class="rsv-x" data-bs-dismiss="modal" aria-label="ë‹«ê¸°">Ã—</button>
            </div>

            <div class="modal-body rsv-body">
                <div id="checkFormWrap">
                    <form class="rsv-form" id="checkForm" onsubmit="return false;">

                        <div class="rsv-grid">
                            <div class="rsv-row">
                                <div class="rsv-label">ì˜ˆì•½ì ì´ë¦„</div>
                                <div class="rsv-field">
                                    <input class="rsv-input" id="chkName" placeholder="ì˜ˆì•½ì ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.">
                                </div>
                            </div>

                            <div class="rsv-row">
                                <div class="rsv-label">íœ´ëŒ€í° ë²ˆí˜¸</div>
                                <div class="rsv-field">
                                    <input class="rsv-input" id="chkPhone" placeholder="- ì—†ì´ ìˆ«ìë§Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.">
                                </div>
                            </div>

                            <div class="rsv-row">
                                <div class="rsv-label">ìƒë…„ì›”ì¼</div>
                                <div class="rsv-field">
                                    <input class="rsv-input" id="chkBirth" placeholder="ìƒë…„ì›”ì¼(YYYY-MM-DD)">
                                </div>
                            </div>
                        </div>

                        <div class="rsv-actions">
                            <button class="rsv-submit" type="button" id="chkSubmitBtn">ì¡°íšŒí•˜ê¸°</button>
                        </div>

                    </form>
                </div>

                <div class="rsv-result" id="checkResultWrap" hidden>
                    <div class="rsv-result-list" id="checkResultList"></div>
                    <div class="rsv-actions">
                        <button class="rsv-submit" type="button" id="chkBackBtn">ë‹¤ì‹œ ì¡°íšŒ</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<input type="hidden" id="csrfToken" value="{{ csrf_token }}">

<script>
    (function () {
        const monthText = document.getElementById("calMonthText");
        const grid = document.getElementById("calGrid");
        const prev = document.getElementById("calPrev");
        const next = document.getElementById("calNext");
        const confirmBtnTop = document.getElementById("calConfirmBtn"); // âœ… ìƒë‹¨ ì˜ˆì•½í™•ì¸(ì¡°íšŒ)
        const csrfToken = document.getElementById("csrfToken")?.value || "";
        const checkFormWrap = document.getElementById("checkFormWrap");
        const checkResultWrap = document.getElementById("checkResultWrap");
        const checkResultList = document.getElementById("checkResultList");
        const chkBackBtn = document.getElementById("chkBackBtn");

        if (!monthText || !grid || !prev || !next) return;

        // âœ… ì‹œê°„ ìŠ¬ë¡¯
        const TIME_SLOTS = [
            "10:00", "10:30", "11:00", "11:30",
            "14:00", "14:30", "15:00", "15:30",
            "16:00", "16:30", "17:00"
        ];

        // ì„ íƒê°’(ì˜ˆì•½ì‹ ì²­ìš©)
        let selectedDate = null; // "YYYY-MM-DD"
        let selectedTime = null; // "HH:MM"

        // ê³µíœ´ì¼
        let holidaySet = new Set();
        let holidayMap = {}; // {"YYYY-MM-DD": "ì„¤ë‚ ", ...}

        function pad(n) { return String(n).padStart(2, "0"); }
        function keyFromDateObj(date) {
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
        }

        async function loadHolidays(year) {
            try {
                const res = await fetch(`/api/holidays?year=${encodeURIComponent(year)}`, { cache: "no-store" });
                if (!res.ok) throw new Error("holiday api not ok");
                const json = await res.json();

                const dates = Array.isArray(json.dates) ? json.dates : [];
                holidaySet = new Set(dates);
                holidayMap = (json.map && typeof json.map === "object") ? json.map : {};
            } catch (e) {
                console.warn("holiday fetch failed:", e);
                holidaySet = new Set();
                holidayMap = {};
            }
        }

        function holidayLabel(date) {
            const key = keyFromDateObj(date);
            return holidayMap[key] || "";
        }

        function normalizePhone(value) {
            return String(value || "").replace(/\D/g, "");
        }

        const CUTOFF_HOUR = 17;
        const CUTOFF_MIN = 0;

        function isPastTimeSlot(dateKey, timeStr) {
            if (!dateKey || !timeStr) return false;
            const today = new Date();
            const todayKey = keyFromDateObj(today);
            if (dateKey !== todayKey) return false;
            const parts = timeStr.split(":");
            if (parts.length !== 2) return false;
            const h = Number(parts[0]);
            const m = Number(parts[1]);
            if (!Number.isFinite(h) || !Number.isFinite(m)) return false;
            const slotMinutes = (h * 60) + m;
            const nowMinutes = (today.getHours() * 60) + today.getMinutes();
            return slotMinutes <= nowMinutes;
        }

        function isAfterTodayCutoff(date) {
            const today = new Date();
            const todayKey = keyFromDateObj(today);
            const dateKey = keyFromDateObj(date);
            if (dateKey !== todayKey) return false;
            const nowMinutes = (today.getHours() * 60) + today.getMinutes();
            const cutoffMinutes = (CUTOFF_HOUR * 60) + CUTOFF_MIN;
            return nowMinutes > cutoffMinutes;
        }


        // âœ… ì˜ˆì•½ì¢…ë£Œ: (ì˜¤ëŠ˜ ì´ì „ ë‚ ì§œ) OR ì¼ìš”ì¼ OR ê³µíœ´ì¼
        function isClosed(date) {
            const dow = date.getDay(); // 0=ì¼
            const key = keyFromDateObj(date);

            // âœ… "ì˜¤ëŠ˜ 00:00" ê¸°ì¤€ìœ¼ë¡œ ê³¼ê±° ì°¨ë‹¨ (ì‹œê°„ ì˜¤ì°¨ ë°©ì§€)
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const d = new Date(date);
            d.setHours(0, 0, 0, 0);

            const isPast = d < today;

            return isPast || (dow === 0) || holidaySet.has(key) || isAfterTodayCutoff(date);
        }

        // ---------------------------
        // ëª¨ë‹¬ í•¸ë“¤(ì˜ˆì•½ì‹ ì²­/ì˜ˆì•½í™•ì¸ ë¶„ë¦¬)
        // ---------------------------
        let reserveModal = null; // confirmModal = ì˜ˆì•½ì‹ ì²­
        function getReserveModal() {
            const el = document.getElementById("confirmModal");
            if (!el || !window.bootstrap) return null;
            if (!reserveModal) reserveModal = new bootstrap.Modal(el);
            return reserveModal;
        }

        let checkModal = null; // checkModal = ì˜ˆì•½í™•ì¸(ì¡°íšŒ)
        function getCheckModal() {
            const el = document.getElementById("checkModal");
            if (!el || !window.bootstrap) return null;
            if (!checkModal) checkModal = new bootstrap.Modal(el);
            return checkModal;
        }

        function fillReserveModal() {
            const dateInput = document.getElementById("cfDateInput");
            const timeSelect = document.getElementById("cfTimeSelect");

            if (dateInput) dateInput.value = selectedDate || "";

            if (timeSelect) {
                timeSelect.innerHTML = `<option value="">ì˜ˆì•½ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</option>`;
                TIME_SLOTS.forEach(t => {
                    const opt = document.createElement("option");
                    opt.value = t;
                    opt.textContent = t;
                    if (isPastTimeSlot(selectedDate, t)) {
                        opt.disabled = true;
                    }
                    if (selectedTime === t) opt.selected = true;
                    timeSelect.appendChild(opt);
                });

                if (timeSelect.value && timeSelect.selectedOptions[0]?.disabled) {
                    timeSelect.value = "";
                    selectedTime = null;
                }

                timeSelect.onchange = () => {
                    selectedTime = timeSelect.value || null;
                };
            }
        }

        function resetReserveForm() {
            // âœ… ì˜ˆì•½ì‹ ì²­ í¼ ì´ˆê¸°í™”(ë‹¤ìŒ ì˜ˆì•½ ì‹œ ì •ë³´ ë‚¨ì§€ ì•Šê²Œ)
            ["cfName", "cfPhone", "cfBirth", "cfMemo"].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = "";
            });

            // ë¼ë””ì˜¤ ì´ˆê¸°í™”
            document.querySelectorAll('input[name="cfGender"]').forEach(r => r.checked = false);
            document.querySelectorAll('input[name="cfVisitType"]').forEach(r => r.checked = false);

            // ì‹œê°„ ì„ íƒ ì´ˆê¸°í™”
            const timeSelect = document.getElementById("cfTimeSelect");
            if (timeSelect) timeSelect.value = "";

            // ë™ì˜ ì´ˆê¸°í™”
            const agreeAll = document.getElementById("agreeAll");
            const agreeItems = Array.from(document.querySelectorAll(".agree-item"));
            if (agreeAll) agreeAll.checked = false;
            agreeItems.forEach(chk => chk.checked = false);

            // ì„ íƒê°’ ì´ˆê¸°í™”
            selectedDate = null;
            selectedTime = null;

            const dateInput = document.getElementById("cfDateInput");
            if (dateInput) dateInput.value = "";
        }

        function openReserveModal() {
            if (!selectedDate) return;
            fillReserveModal();
            const m = getReserveModal();
            if (m) m.show();
            else alert("Bootstrap ëª¨ë‹¬ì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (bootstrap.bundle í™•ì¸)");
        }

        // âœ… ìƒë‹¨ "ì˜ˆì•½í™•ì¸" ë²„íŠ¼ì€ "ì¡°íšŒ ëª¨ë‹¬"ë§Œ ì—´ê¸°
        if (confirmBtnTop) {
            confirmBtnTop.addEventListener("click", () => {
                resetCheckModal();
                const m = getCheckModal();
                if (m) m.show();
                else alert("Bootstrap ëª¨ë‹¬ì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (bootstrap.bundle í™•ì¸)");
            });
        }

        // âœ… ë™ì˜ ì „ì²´ì„ íƒ(ì˜ˆì•½ì‹ ì²­ í¼ìš©)
        const agreeAll = document.getElementById("agreeAll");
        const agreeItems = Array.from(document.querySelectorAll(".agree-item"));
        if (agreeAll && agreeItems.length) {
            agreeAll.addEventListener("change", () => {
                agreeItems.forEach(chk => chk.checked = agreeAll.checked);
            });
            agreeItems.forEach(chk => {
                chk.addEventListener("change", () => {
                    agreeAll.checked = agreeItems.every(x => x.checked);
                });
            });
        }

        // âœ… ì˜ˆì•½ì‹ ì²­ ë²„íŠ¼(ì˜ˆì•½ì‹ ì²­ ëª¨ë‹¬ ë‚´ë¶€)
        const cfSubmitBtn = document.getElementById("cfSubmitBtn");
        if (cfSubmitBtn) {
            cfSubmitBtn.addEventListener("click", async () => {
                const name = (document.getElementById("cfName")?.value || "").trim();
                const phone = normalizePhone(document.getElementById("cfPhone")?.value || "");
                const birth = (document.getElementById("cfBirth")?.value || "").trim();
                const timeVal = (document.getElementById("cfTimeSelect")?.value || "").trim();
                const gender = document.querySelector('input[name="cfGender"]:checked')?.value || "";
                const visitType = document.querySelector('input[name="cfVisitType"]:checked')?.value || "";
                const memo = (document.getElementById("cfMemo")?.value || "").trim();
                const okTerms = document.getElementById("agreeUse")?.checked;
                const okPrivacy = document.getElementById("agreePrivacy")?.checked;

                if (!selectedDate) return alert("ì˜ˆì•½ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                if (!timeVal) return alert("ì˜ˆì•½ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                if (!phone) return alert("ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                if (!birth) return alert("ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                if (!okTerms || !okPrivacy) return alert("í•„ìˆ˜ ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”.");

                try {
                    const res = await fetch("/api/reservations", {
                        method: "POST",
                        credentials: "same-origin",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRF-Token": csrfToken
                        },
                        body: JSON.stringify({
                            date: selectedDate,
                            time: timeVal,
                            name,
                            phone,
                            birth,
                            gender,
                            visit_type: visitType,
                            memo
                        })
                    });

                    if (!res.ok) {
                        throw new Error("reserve failed");
                    }

                    // âœ… ì ‘ìˆ˜ í›„ ì´ˆê¸°í™” + ë‹«ê¸°
                    resetReserveForm();
                    const m = getReserveModal();
                    if (m) m.hide();
                } catch (e) {
                    alert("ì˜ˆì•½ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            });
        }

        // âœ… ì¡°íšŒí•˜ê¸° ë²„íŠ¼(ì˜ˆì•½í™•ì¸ ëª¨ë‹¬ ë‚´ë¶€)
        const chkSubmitBtn = document.getElementById("chkSubmitBtn");
        if (chkSubmitBtn) {
            chkSubmitBtn.addEventListener("click", async () => {
                const n = (document.getElementById("chkName")?.value || "").trim();
                const p = normalizePhone(document.getElementById("chkPhone")?.value || "");
                const b = (document.getElementById("chkBirth")?.value || "").trim();

                if (!n) return alert("ì˜ˆì•½ì ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
                if (!p) return alert("íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
                if (!b) return alert("ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");

                try {
                    const res = await fetch("/api/reservations/check", {
                        method: "POST",
                        credentials: "same-origin",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRF-Token": csrfToken
                        },
                        body: JSON.stringify({
                            name: n,
                            phone: p,
                            birth: b
                        })
                    });

                    if (!res.ok) {
                        throw new Error("check failed");
                    }

                    const json = await res.json();
                    const results = Array.isArray(json.results) ? json.results : [];
                    renderCheckResults(results);
                } catch (e) {
                    alert("ì˜ˆì•½ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            });
        }

        function resetCheckModal() {
            if (checkFormWrap) checkFormWrap.hidden = false;
            if (checkResultWrap) checkResultWrap.hidden = true;
            if (checkResultList) checkResultList.innerHTML = "";
        }

        function makeResultRow(label, value, isTextarea = false) {
            const row = document.createElement("div");
            row.className = "rsv-row";

            const labelEl = document.createElement("div");
            labelEl.className = "rsv-label";
            labelEl.textContent = label;

            const field = document.createElement("div");
            field.className = "rsv-field";

            if (isTextarea) {
                const ta = document.createElement("textarea");
                ta.className = "rsv-input rsv-textarea";
                ta.readOnly = true;
                ta.rows = 3;
                ta.value = value || "";
                field.appendChild(ta);
            } else {
                const input = document.createElement("input");
                input.className = "rsv-input";
                input.readOnly = true;
                input.value = value || "";
                field.appendChild(input);
            }

            row.appendChild(labelEl);
            row.appendChild(field);
            return row;
        }

        function renderCheckResults(results) {
            if (!checkResultList || !checkResultWrap || !checkFormWrap) return;
            checkResultList.innerHTML = "";

            if (!results.length) {
                const empty = document.createElement("div");
                empty.className = "rsv-result-empty";
                empty.textContent = "ì¡°íšŒëœ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.";
                checkResultList.appendChild(empty);
            } else {
                results.forEach((item) => {
                    const wrap = document.createElement("div");
                    wrap.className = "rsv-result-item";
                    const grid = document.createElement("div");
                    grid.className = "rsv-grid";

                    grid.appendChild(makeResultRow("ì˜ˆì•½ì¼", item.date || "-"));
                    grid.appendChild(makeResultRow("ì˜ˆì•½ì‹œê°„", item.time || "-"));
                    grid.appendChild(makeResultRow("ì˜ˆì•½ì", item.name || "-"));
                    grid.appendChild(makeResultRow("ì—°ë½ì²˜", item.phone || "-"));
                    grid.appendChild(makeResultRow("ìƒë…„ì›”ì¼", item.birth || "-"));

                    if (item.gender) {
                        grid.appendChild(makeResultRow("ì„±ë³„", item.gender));
                    }

                    if (item.visit_type) {
                        grid.appendChild(makeResultRow("ì§„ë£Œì¢…ë¥˜", item.visit_type));
                    }

                    if (item.created_at) {
                        grid.appendChild(makeResultRow("ì ‘ìˆ˜ì¼", item.created_at));
                    }

                    if (item.memo) {
                        grid.appendChild(makeResultRow("ë©”ëª¨", item.memo, true));
                    }

                    wrap.appendChild(grid);
                    checkResultList.appendChild(wrap);
                });
            }

            checkFormWrap.hidden = true;
            checkResultWrap.hidden = false;
        }

        if (chkBackBtn) {
            chkBackBtn.addEventListener("click", () => {
                resetCheckModal();
            });
        }

        // ---------------------------
        // ë‹¬ë ¥ ë Œë”
        // ---------------------------
        let cur = new Date(2026, 1, 1); // 2026-02

        let cutoffTimer = null;
        function scheduleCutoffRerender() {
            if (cutoffTimer) {
                clearTimeout(cutoffTimer);
                cutoffTimer = null;
            }
            const now = new Date();
            const cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate(), CUTOFF_HOUR, CUTOFF_MIN, 1, 0);
            if (now >= cutoff) return;
            const ms = cutoff - now;
            cutoffTimer = setTimeout(() => {
                render();
            }, ms);
        }

        function render() {
            const y = cur.getFullYear();
            const m = cur.getMonth();
            monthText.textContent = `${y}ë…„ ${pad(m + 1)}ì›”`;
            grid.innerHTML = "";

            const first = new Date(y, m, 1);
            const last = new Date(y, m + 1, 0);
            const startDow = first.getDay();
            const totalDays = last.getDate();

            // ì• ë¹ˆì¹¸
            for (let i = 0; i < startDow; i++) {
                const cell = document.createElement("div");
                cell.className = "cal-cell is-empty";
                grid.appendChild(cell);
            }

            for (let day = 1; day <= totalDays; day++) {
                const date = new Date(y, m, day);
                const dow = date.getDay();

                const cell = document.createElement("div");
                cell.className = "cal-cell";

                if (dow === 0) cell.classList.add("is-sun");
                if (dow === 6) cell.classList.add("is-sat");

                const top = document.createElement("div");
                top.className = "cal-top";

                const num = document.createElement("div");
                num.className = "cal-num";
                num.textContent = day;

                const hol = holidayLabel(date);
                const holEl = document.createElement("div");
                holEl.className = "cal-hol";
                holEl.textContent = hol;

                top.appendChild(num);
                top.appendChild(holEl);

                const badge = document.createElement("div");
                badge.className = "cal-badge";

                const yyyyMMdd = `${y}-${pad(m + 1)}-${pad(day)}`;

                if (isClosed(date)) {
                    badge.classList.add("is-closed");
                    badge.innerHTML = '<span class="cal-badge-line">ì˜ˆì•½ì¢…ë£Œ</span>';
                    if (hol) cell.classList.add("is-holiday");
                } else {
                    badge.classList.add("is-open");
                    badge.innerHTML = '<span class="cal-badge-line">ì˜ˆì•½ê°€ëŠ¥</span>';
                    cell.classList.add("is-clickable");

                    // âœ… ë‚ ì§œ í´ë¦­ â†’ ì˜ˆì•½ì‹ ì²­ ëª¨ë‹¬ ì¦‰ì‹œ ì˜¤í”ˆ
                    cell.addEventListener("click", () => {
                        selectedDate = yyyyMMdd;
                        selectedTime = null;
                        openReserveModal();
                    });
                }

                cell.appendChild(top);
                cell.appendChild(badge);
                grid.appendChild(cell);
            }

            // ë§ˆì§€ë§‰ ì¤„ ì±„ìš°ê¸°
            const cells = grid.children.length;
            
            scheduleCutoffRerender();
            const remainder = cells % 7;
            if (remainder !== 0) {
                for (let i = 0; i < 7 - remainder; i++) {
                    const cell = document.createElement("div");
                    cell.className = "cal-cell is-empty";
                    grid.appendChild(cell);
                }
            }
        }

        prev.addEventListener("click", async () => {
            const oldY = cur.getFullYear();
            cur = new Date(cur.getFullYear(), cur.getMonth() - 1, 1);
            if (cur.getFullYear() !== oldY) await loadHolidays(cur.getFullYear());
            render();
        });

        next.addEventListener("click", async () => {
            const oldY = cur.getFullYear();
            cur = new Date(cur.getFullYear(), cur.getMonth() + 1, 1);
            if (cur.getFullYear() !== oldY) await loadHolidays(cur.getFullYear());
            render();
        });

        (async () => {
            await loadHolidays(cur.getFullYear());
            render();
        })();

    })();
</script>

{% endblock %}
